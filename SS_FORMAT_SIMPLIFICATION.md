# SS 快速模式格式简化

## 更新日期
2026-01-06

## 变更概述

根据用户反馈，简化 SS 快速模式的格式，使其更加直观和易用。

## 变更内容

### 旧格式
```bash
# 发消息
ss:消息:联系人:消息内容
ss:发消息:联系人:消息内容
ss:xx:联系人:消息内容

# 发朋友圈
ss:朋友圈:朋友圈内容
ss:pyq:朋友圈内容
```

### 新格式
```bash
# 发消息（默认，无需指定类型）
ss:联系人:消息内容

# 发朋友圈（保持不变）
ss:朋友圈:朋友圈内容
ss:pyq:朋友圈内容
```

## 设计理念

### 核心原则
1. **默认行为**：发消息是最常用的操作，应该是默认行为
2. **简化输入**：减少不必要的前缀，提高输入效率
3. **明确例外**：只有非默认行为（如发朋友圈）才需要明确指定

### 格式规则
- **默认规则**：`ss:参数1:参数2` → 如果参数1不是"朋友圈"或"pyq"，则默认为发消息
- **明确指定**：`ss:朋友圈:内容` → 只有朋友圈需要明确指定

## 修改文件

### 1. 核心代码
**文件**: `ai/task_classifier.py`
**函数**: `_parse_ss_mode()`
**变更**:
- 移除对"消息"、"发消息"、"xx"、"msg"等关键词的检查
- 将发消息设为默认行为
- 只检查首个参数是否为"朋友圈"或"pyq"

**新逻辑**：
```python
def _parse_ss_mode(self, task: str) -> Optional[Dict[str, Any]]:
    # 分割字段
    parts = normalized_task.split(':')
    first_param = parts[1].strip().lower()

    # 判断是否为朋友圈
    if first_param in ['朋友圈', 'pyq']:
        # 发朋友圈
        return {
            "type": "post_moment_only_text",
            "recipient": "",
            "content": ':'.join(parts[2:])
        }
    else:
        # 默认为发消息
        return {
            "type": "send_msg",
            "recipient": parts[1],
            "content": ':'.join(parts[2:])
        }
```

### 2. 用户界面
**文件**: `run.py`
**位置**: 交互模式提示信息
**变更**:
- 更新格式说明，移除"消息:"前缀
- 更新示例，使用简化格式
- 添加提示"默认发消息，只需输入联系人和内容"

**修改位置**:
- Line 16: 命令行帮助示例
- Lines 325-337: 交互模式格式说明

### 3. 文档
**文件**: `docs/SS_QUICK_MODE.md`
**变更**: 全面更新文档以反映新格式
- 格式说明章节
- 示例代码
- 技术细节
- 使用建议
- 常见问题

## 示例对比

### 示例 1: 简单消息
```bash
# 旧格式
ss:消息:张三:你好

# 新格式（更简洁）
ss:张三:你好
```

### 示例 2: 批量发送
```bash
# 旧格式
for user in 张三 李四 王五; do
    python run.py -t "ss:消息:$user:会议通知"
done

# 新格式（更简洁）
for user in 张三 李四 王五; do
    python run.py -t "ss:$user:会议通知"
done
```

### 示例 3: API 调用
```python
# 旧格式
task = f"ss:消息:{contact}:{message}"

# 新格式（更简洁）
task = f"ss:{contact}:{message}"
```

### 示例 4: 朋友圈（保持不变）
```bash
# 新旧格式一致
ss:朋友圈:今天天气真好
ss:pyq:分享一个好消息
```

## 优势

### 1. 更简洁
- 减少输入字符数：从 4 个字段减少到 3 个字段
- 更符合直觉：直接指定联系人和内容

### 2. 更高效
- 减少打字时间
- 减少出错机会

### 3. 保持灵活性
- 朋友圈等特殊操作仍然明确
- 未来可扩展其他操作类型

## 向后兼容性

### ⚠️ 破坏性变更
旧格式（如 `ss:消息:张三:你好`）将**不再工作**：
- `ss:消息:张三:你好` → 将被解析为"给名为'消息'的联系人发送'张三:你好'"
- 用户需要更新脚本和习惯

### 迁移指南
如果您有使用旧格式的脚本，请进行以下修改：

**Shell 脚本**:
```bash
# 查找并替换
sed -i 's/ss:消息:/ss:/g' your_script.sh
sed -i 's/ss:发消息:/ss:/g' your_script.sh
sed -i 's/ss:xx:/ss:/g' your_script.sh
sed -i 's/ss:msg:/ss:/g' your_script.sh
```

**Python 代码**:
```python
# 旧代码
task = f"ss:消息:{contact}:{message}"

# 新代码
task = f"ss:{contact}:{message}"
```

## 测试验证

### 运行测试
```bash
python test_simplified_ss_format.py
```

### 测试覆盖
✅ 简化的发消息格式（4个测试用例）
✅ 朋友圈格式保持不变（3个测试用例）
✅ 边界情况（联系人名为"朋友圈"、内容包含多个冒号）

### 测试结果
```
============================================================
简化后的 SS 快速模式格式测试
============================================================

【发消息测试】
✓ ss:张三:你好
✓ ss:李四:早上好，今天开会
✓ ss：王五：时间是明天3:30
✓ SS:客户A:会议通知

【朋友圈测试】
✓ ss:朋友圈:今天天气真好
✓ ss:pyq:分享一个好消息
✓ ss：朋友圈：今日名言：人生苦短

【边界测试】
✓ 正确识别朋友圈关键词
✓ 正确处理内容中的多个冒号
```

## 使用示例

### 交互模式
```bash
$ python run.py -i

选择任务输入模式：
  1. 快速模式（固定格式，零成本，极速响应）
  2. 智能模式（自然语言，AI理解）

请输入选项（1 或 2）: 1

==================================================
           快速模式（SS格式）
==================================================

格式说明：
  发消息（默认）：联系人:消息内容
  发朋友圈：朋友圈:朋友圈内容

示例：
  张三:你好
  李四:早上好，今天开会
  朋友圈:今天天气真好

提示：
  - 冒号支持中英文（: 或 ：）
  - 默认发消息，只需输入联系人和内容
  - 输入 'q' 或 'quit' 退出

--------------------------------------------------
请输入任务（快速格式）: 张三:你好

开始执行任务: ss:张三:你好
[TaskClassifier] 检测到 SS 快速模式
[TaskClassifier] SS 模式解析成功: {'type': 'send_msg', 'recipient': '张三', 'content': '你好'}
...
```

### 命令行模式
```bash
# 发消息
python run.py -t "ss:张三:你好"

# 发朋友圈
python run.py -t "ss:朋友圈:今天天气真好"
```

## 技术细节

### 解析流程
```
输入: ss:张三:你好
    │
    ▼
检测 SS 模式 (startswith 'ss')
    │
    ▼
归一化冒号 (： → :)
    │
    ▼
分割字段: ['ss', '张三', '你好']
    │
    ▼
检查 parts[1] 是否为 '朋友圈' 或 'pyq'
    │
    ├─ 是 → 发朋友圈
    │   return {type: "post_moment_only_text", content: "你好"}
    │
    └─ 否 → 发消息（默认）
        return {type: "send_msg", recipient: "张三", content: "你好"}
```

### 边界情况处理

**情况 1: 联系人名为"朋友圈"**
```bash
输入: ss:朋友圈:你好
行为: 发朋友圈（而非给名为"朋友圈"的人发消息）
说明: 这是设计行为，如需给名为"朋友圈"的人发消息，使用智能模式
```

**情况 2: 内容包含多个冒号**
```bash
输入: ss:张三:时间:明天:下午3:30
解析: recipient="张三", content="时间:明天:下午3:30"
说明: 正确处理，使用 ':'.join(parts[2:]) 合并剩余部分
```

## 注意事项

### 1. 联系人命名限制
如果您有联系人名为"朋友圈"或"pyq"，在快速模式下将无法给他们发消息。
**解决方案**: 使用智能模式 `给朋友圈发消息说你好`

### 2. 格式严格性
SS 快速模式要求严格的格式：
- 必须至少 3 个字段（ss:参数1:参数2）
- 字段之间用冒号分隔
- 格式错误会被识别为无效输入

### 3. 调试方法
如果 SS 模式解析失败，查看日志：
```bash
[TaskClassifier] 检测到 SS 快速模式
[TaskClassifier] SS 模式格式错误：...
```

## 未来扩展

### 可能的新操作类型
未来如需添加其他快速操作，可以采用相同模式：
```bash
# 搜索联系人
ss:搜索:张三

# 添加好友
ss:添加:微信号12345

# 发送文件
ss:文件:张三:/path/to/file.jpg
```

实现方式：在 `_parse_ss_mode()` 中添加更多关键词判断。

## 相关文档

- [SS 快速模式使用指南](./docs/SS_QUICK_MODE.md)
- [模式选择指南](./docs/MODE_SELECTION_GUIDE.md)
- [交互式模式文档](./docs/INTERACTIVE_MODE.md)
- [任务分类器实现](./ai/task_classifier.py)

## 更新日志

**2026-01-06**:
- ✅ 修改 `ai/task_classifier.py` 的 `_parse_ss_mode()` 函数
- ✅ 更新 `run.py` 的交互模式提示信息
- ✅ 全面更新 `docs/SS_QUICK_MODE.md` 文档
- ✅ 创建 `test_simplified_ss_format.py` 测试脚本
- ✅ 所有测试通过

## 总结

这次简化使 SS 快速模式更加符合直觉和高效：

**变化**:
- `ss:消息:张三:你好` → `ss:张三:你好`
- 减少 25% 的输入字符

**保持不变**:
- `ss:朋友圈:今天天气真好` （朋友圈格式不变）
- 速度、准确性、零成本等优势完全保留

**建议**:
- 高频用户更新脚本和习惯
- 新用户直接学习新格式
- 临时用户使用智能模式更方便
