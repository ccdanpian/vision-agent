# LLM 分类失败后自动返回模式选择

## 更新日期
2026-01-06

## 功能说明

当 LLM 分类失败时，系统不再尝试关键词路由，而是：
1. 显示错误信息，告知用户输入有问题
2. 自动返回到模式选择界面
3. 让用户重新选择模式 1 或 2

这样可以避免错误路由导致的不良体验，给用户一个重新选择的机会。

## 问题背景

### 之前的设计

在之前的实现中，当 SS 格式解析失败后，系统会尝试以下回退策略：

```
SS 解析 → 失败
    ↓
LLM 分类 → 失败
    ↓
关键词路由 → 可能匹配到错误的模块
```

**问题**：关键词路由作为最后的 fallback，可能会：
- 匹配到不相关的模块
- 给出低质量的匹配结果
- 让用户困惑（不知道为什么会路由到某个模块）

### 用户需求

用户希望：
> "当LLM匹配失败后自动退出，告诉用户输入有问题需要重新输入，并且回退到初始，让用户选择1或2"

**核心要求**：
1. LLM 失败后不要继续尝试其他方法
2. 告诉用户输入有问题
3. 返回到初始状态（模式选择）
4. 让用户重新选择模式

## 解决方案

### 整体流程

```
用户选择模式（1 或 2）
    ↓
输入任务
    ↓
SS 解析 → 成功 → 执行任务 ✓
    ↓ 失败
LLM 分类 → 成功 → 执行任务 ✓
    ↓ 失败
显示错误信息
    ↓
返回模式选择 ⟲
```

### 实现细节

#### 1. TaskRunner 返回错误（core/task_runner.py）

在 LLM 分类失败时，直接返回错误，而不是继续尝试关键词路由：

```python
# 位置：core/task_runner.py Line 293-303
if parsed_data and parsed_data.get("type") and parsed_data["type"] != "invalid":
    # LLM 分类成功，使用类型路由
    # ...
else:
    # LLM 分类也失败，返回错误，让用户重新选择模式
    self._log("LLM 分类失败或返回 invalid")
    error_msg = "❌ LLM分类失败，无法理解您的输入。\n请重新选择模式，或检查输入格式是否正确。"
    result = TaskResult(
        task=task,
        status=TaskStatus.FAILED,
        error_message=error_msg
    )
    self.state = TaskStatus.FAILED
    return result
```

**关键点**：
- 不再执行 `handler = ModuleRegistry.route(task)`（关键词路由）
- 直接返回 FAILED 状态
- 错误信息明确说明 "LLM分类失败"

#### 2. 交互式模式支持重启（run.py）

将交互式模式改为双层循环结构：

```python
# 位置：run.py Line 300-401
# 外层循环：模式选择
while True:
    # 让用户选择分类模式
    mode_choice = select_mode()  # 1 或 2

    # 内层循环：连续执行任务
    restart_mode_selection = False
    while True:
        task_input = get_user_input()

        # 执行任务
        should_restart = _execute_task_with_retry(runner, task, mode_choice)
        if should_restart:
            restart_mode_selection = True
            break  # 退出任务循环，返回模式选择

    # 检查是否需要重新选择模式
    if not restart_mode_selection:
        break  # 用户选择退出，退出外层循环
```

**关键点**：
- 外层循环负责模式选择
- 内层循环负责任务执行
- `should_restart` 信号控制是否返回模式选择

#### 3. 检测 LLM 失败并返回信号（run.py）

修改 `_execute_task_with_retry` 函数返回类型为 `bool`：

```python
# 位置：run.py Line 404-493
def _execute_task_with_retry(runner, task: str, mode_choice: str = '2', max_retries: int = 5) -> bool:
    """执行任务并支持 invalid 输入后重新输入

    Returns:
        bool: True 表示需要重新选择模式，False 表示继续当前模式
    """
    # 执行任务
    result = runner.run(current_task)

    # 检查是否为 LLM 分类失败 - 需要重新选择模式
    if result.status == TaskStatus.FAILED and "LLM分类失败" in result.error_message:
        print("\n" + "=" * 50)
        print("将返回到模式选择界面")
        print("=" * 50)
        return True  # 返回 True 表示需要重新选择模式

    # 其他错误或成功，继续当前模式
    # ...

    return False  # 返回 False 表示继续当前模式
```

**关键点**：
- 通过检测错误信息中的 "LLM分类失败" 来判断
- 返回 `True` 触发模式重启
- 返回 `False` 继续当前模式

## 执行流程示例

### 场景：用户在快速模式下输入不规范内容

#### 步骤 1：选择模式

```
==================================================
           选择任务分类模式
==================================================

请选择任务输入模式：
  1. 快速模式（固定格式，零成本，极速响应）
  2. 智能模式（自然语言，AI理解）

请输入选项（1 或 2）: 1

==================================================
           快速模式（SS格式）
==================================================

格式说明：
  发消息（默认）：联系人:消息内容
  发朋友圈：朋友圈:朋友圈内容

示例：
  张三:你好
  李四:早上好，今天开会
  朋友圈:今天天气真好
```

#### 步骤 2：输入不规范内容

```
--------------------------------------------------
请输入任务（快速格式）: 但是客服经理

开始执行任务: ss:但是客服经理
[TaskRunner] 检测到 SS 快速模式，尝试解析
[TaskClassifier] SS 模式格式错误：冒号分隔的部分少于3个 (实际: 2)
[TaskRunner] SS 格式解析失败，去掉 'ss:' 前缀，使用 LLM 进行任务分类
[TaskRunner] 转换后的任务: 但是客服经理
[TaskRunner] 调用 LLM 进行任务分类和参数提取
[TaskRunner] LLM 分类失败或返回 invalid
```

#### 步骤 3：显示错误并返回模式选择

```
========================================
执行结果
========================================
状态: failed
耗时: 0.5s

错误: ❌ LLM分类失败，无法理解您的输入。
请重新选择模式，或检查输入格式是否正确。

==================================================
将返回到模式选择界面
==================================================

==================================================
           选择任务分类模式
==================================================

请选择任务输入模式：
  1. 快速模式（固定格式，零成本，极速响应）
  2. 智能模式（自然语言，AI理解）

请输入选项（1 或 2）:
```

#### 步骤 4：用户重新选择

用户可以：
- 选择 1（快速模式）→ 重新输入正确的 SS 格式
- 选择 2（智能模式）→ 使用自然语言描述任务
- 输入 Ctrl+C → 退出程序

## 对比：修改前后

### 修改前

```
用户输入: 但是客服经理（快速模式）
    ↓
系统添加前缀: ss:但是客服经理
    ↓
SS 解析失败 ✗
    ↓
LLM 分类失败 ✗
    ↓
关键词路由（fallback）
    ↓
路由到：系统操作（匹配度 0.00）❌
    ↓
执行失败 ✗
    ↓
用户困惑：为什么路由到系统操作？
```

### 修改后

```
用户输入: 但是客服经理（快速模式）
    ↓
系统添加前缀: ss:但是客服经理
    ↓
SS 解析失败 ✗
    ↓
LLM 分类失败 ✗
    ↓
显示错误信息 ✓
"❌ LLM分类失败，无法理解您的输入。
请重新选择模式，或检查输入格式是否正确。"
    ↓
返回模式选择 ✓
    ↓
用户重新选择 1 或 2 ✓
```

## 修改的文件

### 1. core/task_runner.py

**位置**: Line 293-303

**变更**:
- 删除了关键词路由的 fallback 逻辑
- 添加了 LLM 失败时直接返回错误的逻辑

### 2. run.py

**位置**: Line 300-401（交互式模式）, Line 404-493（执行函数）

**变更**:
- 将交互式模式改为双层循环结构
- 修改 `_execute_task_with_retry` 返回类型为 `bool`
- 添加 LLM 失败检测和模式重启逻辑

## 优势

### 1. 更好的错误处理
- 明确告知用户输入有问题
- 避免错误路由导致的混乱

### 2. 更好的用户体验
- 自动返回模式选择，无需手动退出
- 给用户重新选择的机会
- 减少用户困惑

### 3. 更清晰的逻辑
- 去掉了不可靠的关键词路由 fallback
- 流程更加简洁明了
- 错误处理更加明确

## 完整回退策略

现在系统有以下回退机制：

### 层级 1：格式解析

```
SS 格式解析 → 成功 → 使用 SS 模式路由 ✓
    ↓ 失败
LLM 分类 → 成功 → 使用 LLM 模式路由 ✓
    ↓ 失败
返回错误，重新选择模式 ⟲
```

### 层级 2：任务分类（智能模式）

智能模式下，用户直接输入自然语言：

```
LLM 分类 → 成功 → 执行任务 ✓
    ↓ 失败或返回 invalid
提示用户重新输入（最多 5 次）
    ↓ 仍然失败
返回错误，重新选择模式 ⟲
```

## 测试验证

### 测试脚本

创建了 `test_llm_failure_restart.py` 测试脚本。

### 测试结果

```bash
$ python test_llm_failure_restart.py

============================================================
测试 LLM 分类失败后返回模式选择
============================================================

【测试用例 1】用户在快速模式下的不规范输入

原始任务: ss:但是客服经理
【步骤 1】检测到 SS 快速模式
【步骤 2】尝试 SS 格式解析 → ✗ SS 解析失败
【步骤 3】去掉 'ss:' 前缀 → 但是客服经理
【步骤 4】调用 LLM 进行任务分类 → ✗ LLM 分类失败
【步骤 5】返回错误并重新选择模式
  ❌ LLM分类失败，无法理解您的输入。
  → 返回到模式选择界面
  → 用户可以重新选择 1 或 2

【测试用例 2】无意义输入

原始任务: ss:abc
【步骤 1】检测到 SS 快速模式
【步骤 2】尝试 SS 格式解析 → ✗ SS 解析失败
【步骤 3】去掉 'ss:' 前缀 → abc
【步骤 4】调用 LLM 进行任务分类 → ✗ LLM 分类失败
【步骤 5】返回错误并重新选择模式
  → 返回到模式选择界面
  → 用户可以重新选择 1 或 2

============================================================
测试完成
============================================================

改进效果：
  ✓ LLM 分类失败时不再使用关键词路由
  ✓ 直接返回错误并提示用户
  ✓ 自动返回模式选择界面
  ✓ 用户可以重新选择 1 或 2
```

## 用户场景

### 场景 1：用户不熟悉快速模式格式

```
用户: 选择快速模式
输入: 但是客服经理
结果: ❌ LLM分类失败
系统: 返回模式选择
用户: 选择智能模式
输入: 给客服经理发消息
结果: ✓ 正确执行
```

### 场景 2：用户输入错误

```
用户: 选择快速模式
输入: abc
结果: ❌ LLM分类失败
系统: 返回模式选择
用户: 选择快速模式
输入: 张三:你好
结果: ✓ 正确执行
```

### 场景 3：用户想切换模式

虽然原本的设计不支持运行时切换模式，但现在当 LLM 失败时：

```
用户: 选择快速模式
输入: 复杂的自然语言描述（无法解析）
结果: ❌ LLM分类失败
系统: 返回模式选择
用户: 选择智能模式 ← 实现了"间接的模式切换"
结果: ✓ 正确执行
```

## 相关文档

- [SS 模式回退文档](./SS_FALLBACK_IMPLEMENTATION.md)
- [模式选择指南](./docs/MODE_SELECTION_GUIDE.md)
- [SS 快速模式使用指南](./docs/SS_QUICK_MODE.md)

## 更新日志

**2026-01-06**:
- ✅ 修改 TaskRunner，LLM 失败时直接返回错误
- ✅ 修改 run.py，支持双层循环和模式重启
- ✅ 删除关键词路由作为 fallback 的逻辑
- ✅ 创建测试脚本验证
- ✅ 所有测试通过

## 总结

这次改进使系统的错误处理更加友好：

**问题**：LLM 分类失败后，系统使用关键词路由可能导致错误匹配

**解决**：LLM 失败后直接返回错误，自动返回模式选择界面

**效果**：
- ✅ 避免错误路由
- ✅ 明确告知用户问题
- ✅ 给用户重新选择的机会
- ✅ 提升用户体验

现在用户在使用快速模式时：
- 输入正确格式 → SS 模式快速执行 ⚡
- 输入自然语言 → LLM 分类智能理解 🧠
- 输入无意义内容 → 提示错误，重新选择 🔄

完美的容错体验！🎉
