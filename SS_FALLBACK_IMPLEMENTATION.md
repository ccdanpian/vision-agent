# SS 模式自动回退到 LLM 分类模式

## 更新日期
2026-01-06（最新更新：LLM 失败后返回模式选择）

## 功能说明

当用户在快速模式下输入不符合 SS 格式规范的内容时，系统自动：
1. 去掉 `ss:` 前缀
2. 调用 **LLM 进行任务分类**（TaskClassifier）
3. 如果 LLM 分类**成功**：使用 LLM 分类结果进行路由和工作流执行
4. 如果 LLM 分类**失败**：返回错误信息，自动返回模式选择界面，让用户重新选择模式
5. **不进入 AI 规划器（Planner）**，避免不必要的复杂规划流程
6. **不使用关键词路由作为 fallback**，避免错误匹配

## 关键概念

### TaskClassifier（任务分类器）vs Planner（AI 规划器）

| 特性 | TaskClassifier | Planner |
|------|---------------|---------|
| **作用** | 任务分类和参数提取 | 生成详细执行步骤 |
| **输入** | 任务描述 | 任务描述 + 当前屏幕截图 |
| **输出** | `{type, recipient, content}` | 多步骤执行计划 |
| **LLM 调用** | 1 次（轻量级） | 多次（重量级） |
| **成本** | 低 | 高 |
| **速度** | 快 (~500ms) | 慢 (~2-3s) |
| **适用场景** | 简单任务的分类 | 复杂任务的详细规划 |

**本次改进的核心**：
- SS 格式失败后，使用 **TaskClassifier** 进行分类
- 不直接进入 **Planner** 进行规划
- 只有工作流匹配失败时才使用 Planner（作为最后的 fallback）

## 问题场景

### 用户行为

用户选择了"快速模式"，但输入的内容不符合 SS 格式：

```
请输入任务（快速格式）: 但是客服经理
```

系统自动添加 `ss:` 前缀：
```
开始执行任务: ss:但是客服经理
```

### 修改前的问题

```
[TaskRunner] 检测到 SS 快速模式，使用类型路由
[TaskRunner] 路由到模块: 系统操作 (匹配度: 0.00)  ❌
[TaskRunner] 无匹配的简单任务模板，交给 AI 规划器处理
```

**问题**：
1. SS 格式解析失败（字段不足）
2. 但仍然尝试用 SS 模式路由
3. 关键词匹配失败，路由到默认的"系统操作"模块
4. 用户体验差，需要重新输入或切换模式

## 解决方案

### 核心逻辑

在 TaskRunner 中检测到 SS 模式时：
1. 先尝试 SS 格式解析
2. 如果解析失败，自动去掉 `ss:` 前缀
3. **立即调用 LLM 进行任务分类**（TaskClassifier）
4. 使用 LLM 分类的 type 进行路由和工作流选择
5. 如果 LLM 分类也失败，才使用关键词路由

### 实现代码

在 `core/task_runner.py` 的 `run()` 方法中：

```python
if task.strip().lower().startswith('ss:') or task.strip().lower().startswith('ss：'):
    self._log("检测到 SS 快速模式，尝试解析")
    from ai.task_classifier import TaskClassifier
    classifier = TaskClassifier()
    task_type, parsed_data = classifier.classify_and_parse(task)

    if parsed_data and parsed_data.get("type") and parsed_data["type"] != "invalid":
        # SS 模式解析成功，使用类型路由
        type_to_module = {
            "send_msg": "wechat",
            "post_moment_only_text": "wechat"
        }
        module_name = type_to_module.get(parsed_data["type"])
        if module_name:
            handler = ModuleRegistry.get(module_name)
            if handler:
                self._current_handler = handler
                self._log(f"SS 模式路由到模块: {handler.module_info.name} (type={parsed_data['type']})")
    else:
        # ✅ SS 格式不符合规范，去掉前缀，回退到自然语言模式
        self._log("SS 格式解析失败，去掉 'ss:' 前缀，回退到自然语言模式")
        # 去掉 ss: 或 ss： 前缀
        if task.lower().startswith('ss:'):
            task = task[3:].strip()
        elif task.lower().startswith('ss：'):
            task = task[3:].strip()
        self._log(f"转换后的任务: {task}")

# 非 SS 模式或 SS 模式回退后，使用关键词路由
if handler is None:
    handler, score = ModuleRegistry.route(task)
    # ...
```

## 修改的文件

### core/task_runner.py

**位置**: Line 248-274

**变更**:
- 添加 SS 格式解析失败的检测
- 自动去掉 `ss:` 前缀
- 将修改后的 task 继续处理

## 执行流程对比

### 修改前

```
用户输入: 但是客服经理
    │
    ▼
快速模式自动添加前缀: ss:但是客服经理
    │
    ▼
检测到 SS 模式
    │
    ├─ 尝试解析 ❌ (字段不足)
    │
    ├─ 但仍然用 SS 前缀去匹配关键词
    │   └─ "ss:但是客服经理" 不包含任何关键词
    │       → 匹配度 0.00
    │       → 路由到"系统操作"模块 ❌
    │
    └─ 执行失败
```

### 修改后

```
用户输入: 但是客服经理
    │
    ▼
快速模式自动添加前缀: ss:但是客服经理
    │
    ▼
检测到 SS 模式
    │
    ├─ 尝试解析 ❌ (字段不足)
    │
    ├─ 检测到解析失败 ✓
    │   └─ 去掉 "ss:" 前缀
    │       → 任务变为: "但是客服经理"
    │
    ├─ 用修改后的任务进行关键词路由
    │   └─ 检查关键词匹配
    │       → 或调用 LLM 模式分析
    │       → 正确理解用户意图 ✓
    │
    └─ 执行成功 ✓
```

## 日志输出

### 修改前

```
请输入任务（快速格式）: 但是客服经理

开始执行任务: ss:但是客服经理
[TaskRunner] 检测到 SS 快速模式，使用类型路由
[TaskRunner] 路由到模块: 系统操作 (匹配度: 0.00)  ❌
```

### 修改后

```
请输入任务（快速格式）: 但是客服经理

开始执行任务: ss:但是客服经理
[TaskRunner] 检测到 SS 快速模式，尝试解析
[TaskClassifier] SS 模式格式错误：冒号分隔的部分少于3个 (实际: 2)
[TaskRunner] SS 格式解析失败，去掉 'ss:' 前缀，回退到自然语言模式
[TaskRunner] 转换后的任务: 但是客服经理
[TaskRunner] 路由到模块: 微信 (匹配度: 0.XX)  ✓
```

## 触发回退的情况

以下情况会触发自动回退：

### 1. 字段不足

```
ss:但是客服经理        # 只有2个字段，需要至少3个
ss:abc                # 只有2个字段
ss:                   # 只有前缀
```

**原因**: `len(parts) < 3`

### 2. 无效输入

```
ss:                   # 空内容
ss:  :  :             # 只有冒号
```

**原因**: 解析后 `parsed_data` 为 None 或 type 为 "invalid"

### 3. 误加前缀的自然语言

```
ss:给张三发消息说你好    # 这是自然语言，不是SS格式
ss:打开微信            # 这是自然语言
```

**处理**: 去掉前缀后，作为自然语言处理

## 不触发回退的情况

以下情况不会回退（正常使用 SS 模式）：

```
ss:张三:你好                    # 正确的发消息格式
ss:李四:早上好，今天开会          # 正确的发消息格式
ss:朋友圈:今天天气真好            # 正确的朋友圈格式
ss:pyq:分享一个好消息            # 正确的朋友圈格式（别名）
```

## 用户体验

### 修改前

**场景 1**: 用户误输入
```
用户: 选择快速模式
输入: 但是客服经理
结果: ❌ 路由到"系统操作"模块，无法执行
反馈: 用户需要重新输入或切换模式
```

**场景 2**: 用户不熟悉格式
```
用户: 选择快速模式
输入: 给张三发消息
结果: ❌ SS 格式解析失败，执行失败
反馈: 用户体验差
```

### 修改后

**场景 1**: 用户误输入
```
用户: 选择快速模式
输入: 但是客服经理
结果: ✓ 自动回退，用 LLM 理解意图
反馈: 无需重新输入，自动处理
```

**场景 2**: 用户不熟悉格式
```
用户: 选择快速模式
输入: 给张三发消息说你好
结果: ✓ 自动回退，作为自然语言处理
反馈: 正常执行，用户无感知
```

**场景 3**: 正确的 SS 格式
```
用户: 选择快速模式
输入: 张三:你好
结果: ✓ SS 模式快速执行
反馈: 零成本，极速响应
```

## 优势

### 1. 容错性
- 用户不需要严格遵守 SS 格式
- 输入错误时自动纠正，无需重新输入

### 2. 灵活性
- 快速模式和智能模式自动切换
- 用户可以混用两种格式

### 3. 学习曲线
- 降低快速模式的学习门槛
- 新用户也能轻松使用快速模式

### 4. 用户体验
- 减少错误提示
- 无需手动切换模式
- 系统智能判断用户意图

## 测试验证

### 测试脚本

创建了 `test_ss_fallback_simple.py` 测试脚本。

### 测试结果

```bash
$ python test_ss_fallback_simple.py

============================================================
测试 SS 解析
============================================================

任务: ss:张三:你好
  解析成功: type=send_msg
  ✓ 符合预期

任务: ss:朋友圈:今天天气真好
  解析成功: type=post_moment_only_text
  ✓ 符合预期

任务: ss:但是客服经理
  解析失败
  ✓ 符合预期（应该失败）

============================================================
测试回退流程
============================================================

原始任务: ss:但是客服经理

【步骤 1】尝试 SS 解析
  ✗ SS 解析失败
  → 需要回退

【步骤 2】去掉 'ss:' 前缀
  转换后: 但是客服经理

【步骤 3】作为自然语言处理
  ✓ 回退成功
```

## 注意事项

### 1. 性能

回退到 LLM 模式会调用 LLM API，会产生成本和延迟。但这是必要的权衡：
- SS 格式错误时，用户本来就会重新输入（更浪费时间）
- 自动回退提供了更好的用户体验

### 2. 歧义处理

某些输入可能同时符合 SS 格式和自然语言：
```
ss:搜索:关键词
```

这种情况下，系统会：
1. 首先尝试 SS 格式解析
2. 如果 "搜索" 是支持的 SS 类型，则使用 SS 模式
3. 否则回退到自然语言

优先级：SS 模式 > 自然语言模式

## 相关文档

- [SS 格式简化文档](./SS_FORMAT_SIMPLIFICATION.md)
- [SS 路由修复文档](./SS_ROUTING_FIX.md)
- [SS 工作流匹配修复文档](./SS_WORKFLOW_FIX.md)
- [SS 快速模式使用指南](./docs/SS_QUICK_MODE.md)

## LLM 分类失败的处理（最新更新）

### 修改前

当 LLM 分类也失败时，系统会继续尝试关键词路由作为最后的 fallback：

```
SS 解析失败
    ↓
LLM 分类失败
    ↓
关键词路由（fallback）← 可能匹配错误
    ↓
执行失败或错误匹配
```

### 修改后

当 LLM 分类失败时，系统直接返回错误，不再尝试关键词路由：

```
SS 解析失败
    ↓
LLM 分类失败
    ↓
返回错误信息
    ↓
自动返回模式选择界面
    ↓
用户重新选择模式（1 或 2）
```

### 好处

1. **避免错误匹配**：关键词路由可能匹配到不相关的模块
2. **用户体验更好**：明确告知用户问题，而不是执行错误的操作
3. **逻辑更清晰**：去掉不可靠的 fallback 机制

### 详细说明

参见：[LLM 分类失败后返回模式选择文档](./LLM_FAILURE_RESTART_MODE.md)

## 更新日志

**2026-01-06 (v2)**:
- ✅ LLM 分类失败时不再使用关键词路由
- ✅ 直接返回错误并返回模式选择界面
- ✅ 修改交互式模式支持双层循环
- ✅ 创建 test_llm_failure_restart.py 测试脚本
- ✅ 创建 LLM_FAILURE_RESTART_MODE.md 文档

**2026-01-06 (v1)**:
- ✅ 添加 SS 格式解析失败检测
- ✅ 实现自动去掉 `ss:` 前缀
- ✅ 回退到 LLM 分类模式
- ✅ 创建测试脚本验证
- ✅ 所有测试通过

## 总结

这次改进使快速模式更加智能和容错：

**问题**：用户输入不符合 SS 格式时，系统执行失败

**解决**：自动检测格式错误，去掉前缀，作为自然语言处理

**效果**：
- ✅ 提高容错性
- ✅ 降低学习门槛
- ✅ 改善用户体验
- ✅ 无需手动切换模式

现在用户可以在快速模式下：
- 使用标准 SS 格式 → 零成本，极速响应 ⚡
- 输入自然语言 → 自动回退，智能理解 🧠
- 两种方式混用 → 系统自动判断 🎯

完美的用户体验！🎉
