# SS å¿«é€Ÿæ¨¡å¼ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

SS å¿«é€Ÿæ¨¡å¼æ˜¯ä¸ºé«˜çº§ç”¨æˆ·è®¾è®¡çš„å¿«é€ŸæŒ‡ä»¤é€šé“ï¼Œé€šè¿‡å›ºå®šæ ¼å¼çš„æŒ‡ä»¤ï¼Œç»•è¿‡ LLM åˆ†æï¼Œç›´æ¥è§£æå‚æ•°å¹¶æ‰§è¡Œä»»åŠ¡ã€‚

### ä¼˜åŠ¿

| ç‰¹æ€§ | SS å¿«é€Ÿæ¨¡å¼ | æ™®é€šæ¨¡å¼ |
|------|------------|---------|
| **é€Ÿåº¦** | âš¡ æå¿«ï¼ˆæ—  LLM è°ƒç”¨ï¼‰ | ğŸŒ è¾ƒæ…¢ï¼ˆéœ€è¦ LLM åˆ†æï¼‰ |
| **æˆæœ¬** | âœ… é›¶æˆæœ¬ | ğŸ’° æœ‰ API è°ƒç”¨æˆæœ¬ |
| **å‡†ç¡®æ€§** | âœ… 100%ï¼ˆæ ¼å¼å›ºå®šï¼‰ | âš ï¸ ä¾èµ– LLM ç†è§£ |
| **é€‚ç”¨åœºæ™¯** | é«˜é¢‘é‡å¤ä»»åŠ¡ | è‡ªç„¶è¯­è¨€æè¿° |

---

## ä½¿ç”¨æ ¼å¼

### åŸºæœ¬è§„åˆ™

1. **ä»¥ `ss` å¼€å¤´**ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼šss/SS/Ss/sSï¼‰
2. **ä½¿ç”¨å†’å·åˆ†éš”**ï¼ˆä¸åŒºåˆ†ä¸­è‹±æ–‡ï¼š`:` æˆ– `ï¼š`ï¼‰
3. **æ ¼å¼å›ºå®š**ï¼Œå‚æ•°ä½ç½®ä¸èƒ½é¢ å€’

### æ”¯æŒçš„ä»»åŠ¡ç±»å‹

#### 1. å‘æ¶ˆæ¯ï¼ˆé»˜è®¤ï¼‰

**æ ¼å¼**ï¼š
```
ss:å¥½å‹åç§°:æ¶ˆæ¯å†…å®¹
```

**è¯´æ˜**ï¼š
- é»˜è®¤å°±æ˜¯å‘æ¶ˆæ¯ï¼Œæ— éœ€æŒ‡å®š"æ¶ˆæ¯"å…³é”®è¯
- åªéœ€æä¾›è”ç³»äººå’Œæ¶ˆæ¯å†…å®¹

**ç¤ºä¾‹**ï¼š
```bash
# ä¸­æ–‡å†’å·
ssï¼šå¼ ä¸‰ï¼šä½ å¥½

# è‹±æ–‡å†’å·
ss:æå››:å‘¨æœ«ä¸€èµ·åƒé¥­å§

# å¤§å†™ SS
SS:ç‹äº”:æµ‹è¯•æ¶ˆæ¯

# æ··ç”¨å†’å·
ss:èµµå…­ï¼šHello World

# æ¶ˆæ¯å†…å®¹åŒ…å«å†’å·ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰
ss:å¼ ä¸‰:æ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3:30
```

**è§£æç»“æœ**ï¼š
```json
{
  "type": "send_msg",
  "recipient": "å¼ ä¸‰",
  "content": "ä½ å¥½"
}
```

---

#### 2. å‘æœ‹å‹åœˆ

**æ ¼å¼**ï¼š
```
ss:æœ‹å‹åœˆ:æ¶ˆæ¯å†…å®¹
```

**å…³é”®è¯**ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼š
- `æœ‹å‹åœˆ`ã€`pyq`

**ç¤ºä¾‹**ï¼š
```bash
# ä¸­æ–‡å…³é”®è¯
ss:æœ‹å‹åœˆ:ä»Šå¤©å¤©æ°”çœŸå¥½

# pyq å…³é”®è¯
ss:pyq:åˆ†äº«ä¸€ä¸ªå¥½æ¶ˆæ¯

# å¤§å†™
SS:PYQ:æµ‹è¯•æœ‹å‹åœˆå†…å®¹

# å†…å®¹åŒ…å«å†’å·
ss:æœ‹å‹åœˆ:ä»Šæ—¥åè¨€ï¼šäººç”Ÿè‹¦çŸ­ï¼ŒåŠæ—¶è¡Œä¹
```

**è§£æç»“æœ**ï¼š
```json
{
  "type": "post_moment_only_text",
  "recipient": "",
  "content": "ä»Šå¤©å¤©æ°”çœŸå¥½"
}
```

---

## LLM æ™ºèƒ½æ¨¡å¼çš„ invalid ç±»å‹

### ä»€ä¹ˆæ˜¯ invalid ç±»å‹ï¼Ÿ

LLM æ™ºèƒ½æ¨¡å¼ç°åœ¨å¯ä»¥è¯†åˆ«**æ— æ•ˆè¾“å…¥**ï¼Œé¿å…æµªè´¹èµ„æºã€‚

**æ— æ•ˆè¾“å…¥ç¤ºä¾‹**ï¼š
- ç©ºç™½è¾“å…¥ï¼š`""`, `"   "`, `"\n"`
- æ— æ„ä¹‰å­—ç¬¦ï¼š`"aaa"`, `"123"`, `"!!!"`
- è¯¯è§¦è¾“å…¥ï¼š`"s"`, `"ã€ã€ã€"`
- ä¸æ¸…æ¥šçš„æŒ‡ä»¤ï¼š`"å¸®æˆ‘"`, `"å—¯"`, `"å¥½çš„"`

**å¤„ç†æµç¨‹**ï¼š
```
è¾“å…¥: "aaa" (æ— æ„ä¹‰å­—ç¬¦)
    â†“
LLM è¯†åˆ«ä¸º invalid
    â†“
ç³»ç»Ÿæå‰æ‹¦æˆª
    â†“
è¿”å›å‹å¥½æç¤ºï¼š
"æ— æ•ˆçš„è¾“å…¥æŒ‡ä»¤ã€‚è¯·è¾“å…¥æœ‰æ•ˆçš„ä»»åŠ¡æè¿°ï¼Œä¾‹å¦‚ï¼š
- ç»™å¼ ä¸‰å‘æ¶ˆæ¯è¯´ä½ å¥½
- å‘æœ‹å‹åœˆä»Šå¤©å¤©æ°”çœŸå¥½
- SSå¿«é€Ÿæ¨¡å¼ï¼šss:æ¶ˆæ¯:å¼ ä¸‰:ä½ å¥½"
```

**ä¼˜åŠ¿**ï¼š
- âœ… èŠ‚çœèµ„æºï¼ˆä¸è°ƒç”¨ Planner LLMï¼‰
- âœ… æ›´å¿«å“åº”ï¼ˆ~500ms vs ~2-3ç§’ï¼‰
- âœ… å‹å¥½æç¤ºï¼ˆå¼•å¯¼ç”¨æˆ·æ­£ç¡®è¾“å…¥ï¼‰

è¯¦è§ï¼š[æ— æ•ˆè¾“å…¥å¤„ç†æ–‡æ¡£](./INVALID_INPUT_HANDLING.md)

---

## æ‰§è¡Œæµç¨‹å¯¹æ¯”

### SS å¿«é€Ÿæ¨¡å¼æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "ss:å¼ ä¸‰:ä½ å¥½"
    â”‚
    â–¼
æ£€æµ‹åˆ° SS æ¨¡å¼
    â”‚
    â–¼
å›ºå®šæ ¼å¼è§£æå‚æ•°
{type: "send_msg", recipient: "å¼ ä¸‰", content: "ä½ å¥½"}
    â”‚
    â–¼
åŒ¹é…å·¥ä½œæµ: send_message
    â”‚
    â–¼
æ˜ å°„å‚æ•°: {contact: "å¼ ä¸‰", message: "ä½ å¥½"}
    â”‚
    â–¼
æ‰§è¡Œå·¥ä½œæµ âœ…
```

**è€—æ—¶**ï¼š~50msï¼ˆæ—  API è°ƒç”¨ï¼‰

### æ™®é€šæ¨¡å¼æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "ç»™å¼ ä¸‰å‘æ¶ˆæ¯è¯´ä½ å¥½"
    â”‚
    â–¼
è°ƒç”¨ LLM åˆ†æä»»åŠ¡
    â”‚
    â–¼
LLM è§£æå‚æ•°
{type: "send_msg", recipient: "å¼ ä¸‰", content: "ä½ å¥½"}
    â”‚
    â–¼
åŒ¹é…å·¥ä½œæµ: send_message
    â”‚
    â–¼
æ˜ å°„å‚æ•°: {contact: "å¼ ä¸‰", message: "ä½ å¥½"}
    â”‚
    â–¼
æ‰§è¡Œå·¥ä½œæµ âœ…
```

**è€—æ—¶**ï¼š~500-2000msï¼ˆåŒ…å« LLM API è°ƒç”¨ï¼‰

---

## å¸¸è§é—®é¢˜

### Q1: å†’å·å¿…é¡»æ˜¯ä¸­æ–‡è¿˜æ˜¯è‹±æ–‡ï¼Ÿ

**A**: éƒ½å¯ä»¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«ã€‚

```bash
# è¿™äº›æ ¼å¼éƒ½æœ‰æ•ˆ
ss:å¼ ä¸‰:ä½ å¥½
ssï¼šå¼ ä¸‰ï¼šä½ å¥½
ss:å¼ ä¸‰ï¼šä½ å¥½  # æ··ç”¨ä¹Ÿå¯ä»¥
```

### Q2: SS å‰ç¼€åŒºåˆ†å¤§å°å†™å—ï¼Ÿ

**A**: ä¸åŒºåˆ†ã€‚

```bash
# è¿™äº›éƒ½æœ‰æ•ˆ
ss:å¼ ä¸‰:ä½ å¥½
SS:å¼ ä¸‰:ä½ å¥½
Ss:å¼ ä¸‰:ä½ å¥½
sS:æœ‹å‹åœˆ:ä»Šå¤©å¤©æ°”çœŸå¥½
```

### Q3: æ¶ˆæ¯å†…å®¹åŒ…å«å†’å·æ€ä¹ˆåŠï¼Ÿ

**A**: è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‹…å¿ƒã€‚

```bash
# æ­£ç¡®è§£æ
ss:å¼ ä¸‰:æ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3:30

# è§£æç»“æœ
recipient: "å¼ ä¸‰"
content: "æ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3:30"  # å†’å·è¢«ä¿ç•™
```

### Q4: SS æ¨¡å¼å¤±è´¥ä¼šæ€æ ·ï¼Ÿ

**A**: è‡ªåŠ¨é™çº§åˆ° LLM æ¨¡å¼ã€‚

```bash
# æ ¼å¼é”™è¯¯çš„è¾“å…¥
ss:æœªçŸ¥ç±»å‹:å‚æ•°

# ç³»ç»Ÿè¡Œä¸º
1. æ£€æµ‹åˆ° SS æ¨¡å¼
2. å°è¯•è§£æå¤±è´¥
3. è‡ªåŠ¨é™çº§åˆ° LLM æ¨¡å¼åˆ†æ
4. LLM å°è¯•ç†è§£ä»»åŠ¡
```

### Q5: å¦‚ä½•çŸ¥é“å½“å‰ä½¿ç”¨çš„æ˜¯å“ªç§æ¨¡å¼ï¼Ÿ

**A**: æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚

```bash
# SS å¿«é€Ÿæ¨¡å¼
[TaskClassifier] æ£€æµ‹åˆ° SS å¿«é€Ÿæ¨¡å¼
[TaskClassifier] SS æ¨¡å¼è§£ææˆåŠŸ: {'type': 'send_msg', ...}

# LLM æ™ºèƒ½æ¨¡å¼
[TaskClassifier] LLMå“åº”: {"type": "send_msg", ...}
[TaskClassifier] LLMè§£æ: type=send_msg, ...
```

---

## ä½¿ç”¨å»ºè®®

### é€‚åˆä½¿ç”¨ SS å¿«é€Ÿæ¨¡å¼çš„åœºæ™¯

âœ… **é«˜é¢‘é‡å¤ä»»åŠ¡**
```bash
# æ¯å¤©å›ºå®šå‘æ¶ˆæ¯ç»™å®¢æˆ·
ss:å®¢æˆ·A:æ—©ä¸Šå¥½
ss:å®¢æˆ·B:æ—©ä¸Šå¥½
```

âœ… **æ‰¹é‡æ“ä½œè„šæœ¬**
```bash
#!/bin/bash
# æ‰¹é‡å‘é€é€šçŸ¥
for user in å¼ ä¸‰ æå›› ç‹äº”; do
    python main.py "ss:$user:ä¼šè®®é€šçŸ¥ï¼šæ˜å¤©ä¸‹åˆ2ç‚¹"
done
```

âœ… **API é›†æˆ**
```python
# å…¶ä»–ç¨‹åºè°ƒç”¨
def send_wechat_message(contact, message):
    task = f"ss:{contact}:{message}"
    return execute_task(task)
```

### æ¨èä½¿ç”¨æ™®é€šæ¨¡å¼çš„åœºæ™¯

âœ… **è‡ªç„¶è¯­è¨€æè¿°**
```bash
# å¤æ‚çš„ä»»åŠ¡æè¿°
ç»™å¼ ä¸‰å‘æ¶ˆæ¯è¯´æ˜å¤©å¼€ä¼šï¼Œç„¶åæˆªå›¾å‘æœ‹å‹åœˆ
```

âœ… **ä¸ç¡®å®šæ ¼å¼çš„åœºæ™¯**
```bash
# ç”¨æˆ·è¾“å…¥ä¸è§„èŒƒ
å‘ä¸ªå¾®ä¿¡ç»™å°æ˜è¯´ä½ å¥½
```

âœ… **éœ€è¦ LLM ç†è§£æ„å›¾**
```bash
# å«ç³Šçš„æè¿°
å‘Šè¯‰æå››ä¸€å£°
```

---

## æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd /home/lighthouse/app/vision-agent
python test_ss_mode.py
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
ã€æµ‹è¯•ç”¨ä¾‹ 1ã€‘
è¾“å…¥: ssï¼šå¼ ä¸‰ï¼šä½ å¥½
[TaskClassifier] æ£€æµ‹åˆ° SS å¿«é€Ÿæ¨¡å¼
[TaskClassifier] SS æ¨¡å¼è§£ææˆåŠŸ: {'type': 'send_msg', 'recipient': 'å¼ ä¸‰', 'content': 'ä½ å¥½'}
âœ“ æµ‹è¯•é€šè¿‡
  type: send_msg
  recipient: å¼ ä¸‰
  content: ä½ å¥½
```

---

## æŠ€æœ¯ç»†èŠ‚

### è§£ææµç¨‹

```python
# 1. æ£€æµ‹ SS æ¨¡å¼
if task.lower().startswith('ss'):
    # 2. å½’ä¸€åŒ–å†’å·
    normalized = task.replace('ï¼š', ':')

    # 3. åˆ†å‰²å­—æ®µ
    parts = normalized.split(':')
    # parts[0] = 'ss'
    # parts[1] = è”ç³»äºº æˆ– æœ‹å‹åœˆ/pyq
    # parts[2:] = æ¶ˆæ¯å†…å®¹

    # 4. åˆ¤æ–­ä»»åŠ¡ç±»å‹
    first_param = parts[1].strip().lower()

    if first_param in ['æœ‹å‹åœˆ', 'pyq']:
        # å‘æœ‹å‹åœˆ
        return {
            "type": "post_moment_only_text",
            "recipient": "",
            "content": ':'.join(parts[2:])  # åˆå¹¶å‰©ä½™éƒ¨åˆ†
        }
    else:
        # é»˜è®¤ä¸ºå‘æ¶ˆæ¯
        return {
            "type": "send_msg",
            "recipient": parts[1],  # è”ç³»äºº
            "content": ':'.join(parts[2:])  # æ¶ˆæ¯å†…å®¹
        }
```

### å‚æ•°æ˜ å°„

```python
# SS æ¨¡å¼è§£æçš„æ•°æ®
parsed_data = {
    "type": "send_msg",
    "recipient": "å¼ ä¸‰",
    "content": "ä½ å¥½"
}

# æ˜ å°„åˆ°å·¥ä½œæµå‚æ•°
if workflow_name == "send_message":
    params = {
        "contact": parsed_data["recipient"],  # å¼ ä¸‰
        "message": parsed_data["content"]     # ä½ å¥½
    }
```

---

## æ‰©å±•æ–°çš„ä»»åŠ¡ç±»å‹

å¦‚æœéœ€è¦æ”¯æŒæ–°çš„ SS å¿«é€Ÿæ¨¡å¼ä»»åŠ¡ç±»å‹ï¼Œä¿®æ”¹ `ai/task_classifier.py` ä¸­çš„ `_parse_ss_mode()` æ–¹æ³•ï¼š

```python
def _parse_ss_mode(self, task: str) -> Optional[Dict[str, Any]]:
    # ... ç°æœ‰ä»£ç  ...

    # æ·»åŠ æ–°ä»»åŠ¡ç±»å‹
    elif task_type_str in ['æœç´¢', 'search']:
        # ss:æœç´¢:å…³é”®è¯
        if len(parts) < 3:
            return None

        keyword = ':'.join(parts[2:]).strip()
        return {
            "type": "search_contact",
            "recipient": keyword,
            "content": ""
        }
```

ç„¶ååœ¨ `apps/wechat/handler.py` çš„ `_map_parsed_data_to_workflow_params()` ä¸­æ·»åŠ æ˜ å°„ï¼š

```python
def _map_parsed_data_to_workflow_params(...):
    # ... ç°æœ‰ä»£ç  ...

    elif workflow_name == "search_contact":
        params["keyword"] = recipient or content
```

---

## æ€»ç»“

| é¡¹ç›® | SS å¿«é€Ÿæ¨¡å¼ | æ™®é€šæ¨¡å¼ |
|------|------------|---------|
| **ä½¿ç”¨é—¨æ§›** | éœ€è¦è®°ä½æ ¼å¼ | æ— é—¨æ§›ï¼Œè‡ªç„¶è¯­è¨€ |
| **æ‰§è¡Œé€Ÿåº¦** | âš¡âš¡âš¡ æå¿« | ğŸŒ è¾ƒæ…¢ |
| **æˆæœ¬** | ğŸ’° é›¶æˆæœ¬ | ğŸ’°ğŸ’° æœ‰æˆæœ¬ |
| **å‡†ç¡®ç‡** | âœ… 100% | âš ï¸ 95% |
| **é€‚ç”¨åœºæ™¯** | é«˜é¢‘ã€æ‰¹é‡ã€è‡ªåŠ¨åŒ– | ä¸´æ—¶ã€å¤æ‚ã€è‡ªç„¶æè¿° |
| **å®¹é”™æ€§** | âŒ æ ¼å¼ä¸¥æ ¼ | âœ… é«˜å®¹é”™ |

**å»ºè®®**ï¼š
- é«˜çº§ç”¨æˆ·ã€è‡ªåŠ¨åŒ–è„šæœ¬ â†’ ä½¿ç”¨ SS å¿«é€Ÿæ¨¡å¼
- æ™®é€šç”¨æˆ·ã€å¶å°”ä½¿ç”¨ â†’ ä½¿ç”¨æ™®é€šæ¨¡å¼
- ä¸¤ç§æ¨¡å¼å¯ä»¥æ··ç”¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­
