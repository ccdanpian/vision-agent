# 交互式模式使用指南

## 概述

交互式模式允许用户连续输入多个任务，并在识别到无效输入时自动提示重新输入，无需重新启动程序。

---

## 启动交互式模式

### 方法 1：使用默认设备

```bash
python run.py -i
# 或
python run.py --interactive
```

### 方法 2：指定设备

```bash
python run.py -d emulator-5554 -i
# 或
python run.py -d 192.168.1.100:5555 --interactive
```

---

## 功能特性

### 1. 连续执行多个任务

无需重新运行程序，可以连续输入多个任务：

```
请输入任务: 给张三发消息说你好
（执行任务...）

请输入任务: 发朋友圈今天天气真好
（执行任务...）

请输入任务: ss:消息:李四:下午见
（执行任务...）
```

### 2. 无效输入自动重试

当识别到无效输入时，自动提示重新输入：

```
请输入任务: aaa

（系统识别为 invalid）

========================================
执行结果
========================================
状态: failed
耗时: 0.5s

错误: 无效的输入指令。请输入有效的任务描述，例如：
- 给张三发消息说你好
- 发朋友圈今天天气真好
- SS快速模式：ss:消息:张三:你好

----------------------------------------
请重新输入任务（输入 'q' 取消）: 给张三发消息说你好

（重新执行任务...）
```

### 3. 多种退出方式

- 输入 `q` 或 `quit` 退出
- 按 `Ctrl+C` 退出
- 输入 `exit` 退出

### 4. 防止无限循环

- 单个任务最多重试 5 次
- 超过限制自动取消当前任务
- 返回主循环，可输入新任务

---

## 使用示例

### 示例 1：正常使用流程

```bash
$ python run.py -i

==================================================
           交互式任务模式
==================================================

设备: emulator-5554
已连接，屏幕尺寸: (1080, 2340)

提示：
  - 输入任务描述开始执行
  - 输入 'q' 或 'quit' 退出
  - 按 Ctrl+C 也可以退出
  - 无效输入会自动提示重新输入

--------------------------------------------------
请输入任务: 给张三发消息说你好

开始执行任务: 给张三发消息说你好
...（执行成功）

--------------------------------------------------
请输入任务: 发朋友圈今天天气真好

开始执行任务: 发朋友圈今天天气真好
...（执行成功）

--------------------------------------------------
请输入任务: q
退出交互式模式
```

### 示例 2：处理无效输入

```bash
--------------------------------------------------
请输入任务: aaa

开始执行任务: aaa
[TaskClassifier] LLM判断：无效输入

========================================
执行结果
========================================
状态: failed
耗时: 0.5s

错误: 无效的输入指令。请输入有效的任务描述，例如：
- 给张三发消息说你好
- 发朋友圈今天天气真好
- SS快速模式：ss:消息:张三:你好

----------------------------------------
请重新输入任务（输入 'q' 取消）: 给张三发消息说你好

开始执行任务: 给张三发消息说你好
...（执行成功）

--------------------------------------------------
请输入任务:
```

### 示例 3：使用 SS 快速模式

```bash
--------------------------------------------------
请输入任务: ss:消息:张三:你好

开始执行任务: ss:消息:张三:你好
[TaskClassifier] 检测到 SS 快速模式
[TaskClassifier] SS解析成功

========================================
执行结果
========================================
状态: success
耗时: 2.3s

执行步骤 (3 步):
  1. ✓ 打开微信
  2. ✓ 搜索联系人：张三
  3. ✓ 发送消息：你好

--------------------------------------------------
请输入任务: ss:朋友圈:今天天气真好

开始执行任务: ss:朋友圈:今天天气真好
...（执行成功）
```

---

## 单任务模式 vs 交互式模式

### 单任务模式

适合脚本调用、自动化场景：

```bash
python run.py -t "给张三发消息说你好"
```

**特点**：
- 执行单个任务后退出
- 识别到 invalid 会提示重新输入
- 重试后退出程序

### 交互式模式（推荐）

适合手动测试、连续操作：

```bash
python run.py -i
```

**特点**：
- 可连续执行多个任务
- 识别到 invalid 自动重试
- 任务完成后可继续输入新任务
- 退出方便（q/quit/Ctrl+C）

---

## 退出和取消

### 退出整个交互式模式

```
请输入任务: q
退出交互式模式
```

或按 `Ctrl+C`：

```
请输入任务: ^C

退出交互式模式
```

### 取消当前任务的重试

当输入无效后：

```
请重新输入任务（输入 'q' 取消）: q
取消当前任务

--------------------------------------------------
请输入任务: （返回主循环，可输入新任务）
```

---

## 防止无限循环机制

### 单任务最多重试 5 次

```
请重新输入任务（输入 'q' 取消）: aaa
（第 1 次无效输入）

请重新输入任务（输入 'q' 取消）: 123
（第 2 次无效输入）

...

请重新输入任务（输入 'q' 取消）: !!!
（第 5 次无效输入）

已达到最大重试次数 (5)，取消当前任务

--------------------------------------------------
请输入任务: （返回主循环）
```

---

## 技术实现

### 核心逻辑

1. **主循环**：`run_interactive_mode()`
   - 连接设备
   - 循环接收用户输入
   - 调用任务执行函数

2. **任务执行与重试**：`_execute_task_with_retry()`
   - 执行任务
   - 检查结果
   - 如果是 invalid，提示重新输入
   - 最多重试 5 次

3. **Invalid 检测**：
   ```python
   if result.status == TaskStatus.FAILED and "无效的输入指令" in result.error_message:
       # 提示重新输入
   ```

### 代码结构

```
run.py
├── run_interactive_mode()       # 交互式模式主循环
│   └── _execute_task_with_retry()  # 执行任务并支持重试
│
├── run_task()                   # 单任务模式
│   └── _execute_task_with_retry()  # 复用同样的重试逻辑
```

---

## 常见问题

### Q1: 如何在交互式模式中退出？

**A**: 三种方式：
- 输入 `q` 或 `quit` 或 `exit`
- 按 `Ctrl+C`
- 关闭终端窗口

### Q2: 无效输入会一直提示重新输入吗？

**A**: 不会。单个任务最多重试 5 次，超过后自动取消，返回主循环。

### Q3: 交互式模式支持 SS 快速模式吗？

**A**: 完全支持。输入 `ss:消息:张三:你好` 即可。

### Q4: 可以在交互式模式中执行多个不同类型的任务吗？

**A**: 可以。交互式模式支持所有任务类型，包括：
- 发消息
- 发朋友圈
- 复杂任务
- SS 快速模式
- 其他自定义任务

### Q5: 如果连续输入空白会怎样？

**A**: 系统会提示"输入为空，请重新输入"，不会消耗 LLM 资源。

---

## 最佳实践

### 1. 日常测试使用交互式模式

```bash
# 启动一次，连续测试多个任务
python run.py -i
```

### 2. 脚本自动化使用单任务模式

```bash
# 批量处理
for user in 张三 李四 王五; do
    python run.py -t "ss:消息:$user:早上好"
done
```

### 3. 无效输入处理

- 输入 invalid 后，根据提示输入正确格式
- 或使用 SS 快速模式（100% 不会误判）

### 4. 组合使用

```bash
# 先用 SS 模式快速执行高频任务
python run.py -t "ss:消息:张三:你好"

# 再用交互式模式处理复杂任务
python run.py -i
```

---

## 总结

| 特性 | 单任务模式 | 交互式模式 |
|------|-----------|-----------|
| **启动命令** | `-t "任务"` | `-i` 或 `--interactive` |
| **连续执行** | ❌ 执行完退出 | ✅ 可连续输入 |
| **Invalid 重试** | ✅ 提示重新输入 | ✅ 自动重试 |
| **退出方式** | 自动退出 | q/quit/Ctrl+C |
| **适用场景** | 脚本/自动化 | 手动测试/探索 |
| **推荐度** | 🌟🌟🌟 | 🌟🌟🌟🌟🌟 |

**推荐：日常使用交互式模式，自动化脚本使用单任务模式或 SS 快速模式。**
