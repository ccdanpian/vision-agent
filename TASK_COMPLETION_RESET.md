# 任务完成后自动复位机制

## 更新日期
2026-01-06

## 功能说明

在执行工作流任务后（无论成功还是失败），系统会自动执行复位操作，确保微信返回到消息页面（首页）。

这样可以确保：
1. **每次任务都从相同的初始状态开始**
2. **避免上一次任务的状态影响下一次任务**
3. **提高任务执行的可靠性和一致性**

## 实现位置

**文件**: `apps/wechat/workflow_executor.py`

**方法**: `execute_workflow()` (Line 571-707)

## 实现原理

使用 Python 的 `try-finally` 结构，确保无论任务成功还是失败，都会执行复位操作：

```python
def execute_workflow(self, workflow: Workflow, params: Dict[str, Any]) -> Dict[str, Any]:
    try:
        # 0. 确保微信已打开并在前台
        # 1. 检测当前界面
        # 2. 确保在有效起始界面
        # 3. 执行工作流步骤
        # ...

        return {
            "success": True,
            "message": "工作流执行成功",
            "data": None
        }

    finally:
        # 任务完成后执行复位（无论成功还是失败）
        self._log("")
        self._log("╔════════════════════════════════════════╗")
        self._log("║       【复位流程】任务完成后复位        ║")
        self._log("╚════════════════════════════════════════╝")
        self._log("")

        try:
            reset_success = self._ensure_at_home_screen()
            if reset_success:
                self._log("✓ 复位成功，已返回首页")
            else:
                self._log("⚠️  复位失败，但不影响任务结果")
        except Exception as e:
            self._log(f"⚠️  复位过程出现异常: {e}")
            self._log("  （不影响任务结果）")
```

## 复位流程

复位操作调用 `_ensure_at_home_screen()` 方法，该方法会：

1. **检测是否能看到底部消息Tab** (wechat_home_button)
2. **如果能看到**：点击它，确保进入聊天列表页
3. **如果看不到**：
   - 优先点击取消按钮 (wechat_cancel_button)
   - 其次点击返回按钮 (wechat_back)
4. **重复步骤1-3**，最多尝试5次
5. **返回结果**：成功返回 `True`，失败返回 `False`

## 执行流程示例

### 任务成功的情况

```
=== 执行工作流: send_message ===
  描述: 给联系人发送消息
  参数: {'recipient': '张三', 'content': '你好'}

╔════════════════════════════════════════╗
║       【预置流程】正式任务前准备        ║
╚════════════════════════════════════════╝

[预置] 步骤0: 使用系统指令启动微信
  ✓ 微信已在前台

[预置] 步骤1: 确保微信在消息页面
  检测第 1/5 次...
  检测到消息Tab，点击进入聊天界面 (270, 1520)
  ✓ 已进入消息页面

╔════════════════════════════════════════╗
║     【预置流程完成】开始执行正式任务    ║
╚════════════════════════════════════════╝

  步骤 1: 点击搜索框
  ✓ 步骤 1 完成

  步骤 2: 输入联系人名称
  ✓ 步骤 2 完成

  步骤 3: 点击搜索结果
  ✓ 步骤 3 完成

  步骤 4: 输入消息内容
  ✓ 步骤 4 完成

  步骤 5: 点击发送按钮
  ✓ 步骤 5 完成

=== 工作流完成 ===

╔════════════════════════════════════════╗
║       【复位流程】任务完成后复位        ║
╚════════════════════════════════════════╝

[预置] 步骤1: 确保微信在消息页面
  检测第 1/5 次...
  未检测到消息Tab，尝试返回...
  找到返回按钮，点击 (60, 120)
  检测第 2/5 次...
  检测到消息Tab，点击进入聊天界面 (270, 1520)
  ✓ 已进入消息页面

╔════════════════════════════════════════╗
║     【预置流程完成】开始执行正式任务    ║
╚════════════════════════════════════════╝

✓ 复位成功，已返回首页
```

### 任务失败的情况

```
=== 执行工作流: send_message ===
  描述: 给联系人发送消息
  参数: {'recipient': '不存在的人', 'content': '你好'}

╔════════════════════════════════════════╗
║       【预置流程】正式任务前准备        ║
╚════════════════════════════════════════╝

[预置] 步骤0: 使用系统指令启动微信
  ✓ 微信已在前台

[预置] 步骤1: 确保微信在消息页面
  ✓ 已进入消息页面

╔════════════════════════════════════════╗
║     【预置流程完成】开始执行正式任务    ║
╚════════════════════════════════════════╝

  步骤 1: 点击搜索框
  ✓ 步骤 1 完成

  步骤 2: 输入联系人名称
  ✓ 步骤 2 完成

  步骤 3: 点击搜索结果
  ✗ 步骤失败: 未找到联系人

  尝试恢复...
  ✗ 恢复失败

╔════════════════════════════════════════╗
║       【复位流程】任务完成后复位        ║
╚════════════════════════════════════════╝

[预置] 步骤1: 确保微信在消息页面
  检测第 1/5 次...
  未检测到消息Tab，尝试返回...
  找到取消按钮，点击 (540, 1200)
  检测第 2/5 次...
  未检测到消息Tab，尝试返回...
  找到返回按钮，点击 (60, 120)
  检测第 3/5 次...
  检测到消息Tab，点击进入聊天界面 (270, 1520)
  ✓ 已进入消息页面

╔════════════════════════════════════════╗
║     【预置流程完成】开始执行正式任务    ║
╚════════════════════════════════════════╝

✓ 复位成功，已返回首页

返回错误: 步骤 3 失败且无法恢复: 未找到联系人
```

## 关键设计点

### 1. 使用 try-finally 确保执行

```python
try:
    # 执行任务
    # 可能有多个 return 点
    return {"success": True, ...}
finally:
    # 无论如何都会执行
    self._ensure_at_home_screen()
```

**好处**：
- 即使任务执行过程中有多个 `return` 语句
- 即使任务执行失败
- 即使任务执行过程中抛出异常
- `finally` 块都会被执行

### 2. 复位失败不影响任务结果

```python
try:
    reset_success = self._ensure_at_home_screen()
    if reset_success:
        self._log("✓ 复位成功，已返回首页")
    else:
        self._log("⚠️  复位失败，但不影响任务结果")
except Exception as e:
    self._log(f"⚠️  复位过程出现异常: {e}")
    self._log("  （不影响任务结果）")
```

**原因**：
- 任务的成功/失败已经确定
- 复位操作只是为了准备下一次任务
- 复位失败不应该改变当前任务的执行结果

### 3. 复位操作有异常处理

在 `finally` 块中再使用 `try-except`，确保：
- 复位过程中的异常不会导致程序崩溃
- 即使复位失败，也会记录日志
- 不会影响任务结果的返回

## 完整的任务执行周期

```
┌─────────────────────────────────────────┐
│       1. 开始执行工作流                  │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  2. 预置流程（任务前准备）               │
│     - 启动微信                          │
│     - 确保在消息页面                     │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  3. 执行工作流步骤                       │
│     - 步骤 1                            │
│     - 步骤 2                            │
│     - ...                               │
│     - 步骤 N                            │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  4. 返回任务结果                         │
│     - success: True/False               │
│     - message: ...                      │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  5. 复位流程（任务后复位）← finally 块   │
│     - 确保返回消息页面                   │
│     - 为下一次任务做准备                 │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  6. 结束                                │
└─────────────────────────────────────────┘
```

## 对比：修改前后

### 修改前

```
任务1 执行
    → 停留在聊天页面

任务2 执行
    → 从聊天页面开始（不是首页）
    → 可能导致步骤匹配错误 ❌
```

### 修改后

```
任务1 执行
    → 自动复位 → 返回首页 ✓

任务2 执行
    → 从首页开始
    → 执行稳定可靠 ✓
```

## 优势

### 1. 任务隔离性
- 每次任务都从相同的初始状态开始
- 避免上一次任务的状态影响下一次任务

### 2. 提高可靠性
- 减少因为界面状态不一致导致的失败
- 预置流程和复位流程互相配合

### 3. 更好的调试体验
- 每次任务开始和结束都有明确的状态
- 日志清晰，便于排查问题

### 4. 支持连续执行
- 交互式模式下，用户可以连续输入多个任务
- 每次都会自动复位，无需手动操作

## 注意事项

### 1. 复位时间

复位操作会增加每次任务的执行时间：
- 最快：1次检测 (~1秒)
- 平均：2-3次尝试 (~3-5秒)
- 最慢：5次尝试 (~10秒)

**权衡**：虽然增加了时间，但提高了可靠性和一致性

### 2. 复位失败的处理

如果复位失败（极少情况）：
- 不影响当前任务的结果
- 记录警告日志
- 下一次任务的预置流程会处理

### 3. 性能优化

如果需要优化性能，可以考虑：
- 添加配置项控制是否启用复位
- 对于某些简单任务跳过复位
- 批量任务只在最后复位一次

## 相关文档

- [预置流程说明](./docs/channel-guide/02-workflow-system.md#预置流程)
- [工作流系统文档](./docs/channel-guide/02-workflow-system.md)
- [任务执行器文档](./docs/channel-guide/04-workflow-executor.md)

## 更新日志

**2026-01-06**:
- ✅ 添加 try-finally 结构
- ✅ 在 finally 块中调用 `_ensure_at_home_screen()`
- ✅ 添加异常处理确保复位失败不影响任务结果
- ✅ 添加详细的日志输出
- ✅ 创建文档说明

## 总结

任务完成后自动复位机制确保了：

**核心价值**：
- ✅ 每次任务都从相同的初始状态开始
- ✅ 提高任务执行的可靠性和一致性
- ✅ 支持连续执行多个任务
- ✅ 便于调试和问题排查

**实现方式**：
- 使用 `try-finally` 确保复位一定执行
- 复位失败不影响任务结果
- 添加详细的日志输出

现在每个任务都有完整的生命周期：
```
预置准备 → 执行任务 → 返回结果 → 复位清理
```

完美！🎉
